import com.fasterxml.jackson.databind.ObjectMapper;
import com.netflix.conductor.common.run.Workflow;
import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

public class TestSerDerWorkflow {

    private static final String serverJson = "{\"variables\":{\"sample_key\":\"sample_value\"},\"workflowDefinition\":{\"workflowStatusListenerSink\":\"sample_workflowStatusListenerSink\",\"variables\":{\"sample_key\":\"sample_value\"},\"schemaVersion\":123,\"timeoutPolicy\":{\"values\":[\"TIME_OUT_WF\",\"ALERT_ONLY\"],\"constants\":{\"ALERT_ONLY\":\"(1)\",\"TIME_OUT_WF\":\"(0)\"},\"sampleValue\":\"TIME_OUT_WF\"},\"outputSchema\":{\"data\":{\"sample_key\":\"sample_value\"},\"name\":\"sample_name\",\"type\":\"SchemaDef.Type\",\"version\":123,\"externalRef\":\"sample_externalRef\"},\"enforceSchema\":true,\"restartable\":true,\"inputSchema\":{\"data\":{\"sample_key\":\"sample_value\"},\"name\":\"sample_name\",\"type\":\"SchemaDef.Type\",\"version\":123,\"externalRef\":\"sample_externalRef\"},\"description\":\"sample_description\",\"version\":123,\"inputParameters\":[\"sample_inputParameters\"],\"inputTemplate\":{\"sample_key\":\"sample_value\"},\"workflowStatusListenerEnabled\":true,\"ownerEmail\":\"sample_ownerEmail\",\"rateLimitConfig\":{\"concurrentExecLimit\":123,\"rateLimitKey\":\"sample_rateLimitKey\"},\"name\":\"sample_name\",\"timeoutSeconds\":123,\"failureWorkflow\":\"sample_failureWorkflow\",\"tasks\":[{\"joinOn\":[\"sample_joinOn\"],\"description\":\"sample_description\",\"scriptExpression\":\"sample_scriptExpression\",\"cacheConfig\":{\"key\":\"sample_key\",\"ttlInSecond\":123},\"type\":\"sample_type\",\"inputParameters\":{\"sample_key\":\"sample_value\"},\"decisionCases\":{\"sample_key\":[{\"joinOn\":[\"sample_joinOn\"],\"description\":\"sample_description\",\"scriptExpression\":\"sample_scriptExpression\",\"cacheConfig\":{\"key\":\"sample_key\",\"ttlInSecond\":123},\"type\":\"sample_type\",\"inputParameters\":{\"sample_key\":\"sample_value\"},\"decisionCases\":{},\"loopOver\":[],\"caseExpression\":\"sample_caseExpression\",\"defaultExclusiveJoinTask\":[\"sample_defaultExclusiveJoinTask\"],\"taskDefinition\":{\"timeoutPolicy\":{\"values\":[\"RETRY\",\"TIME_OUT_WF\",\"ALERT_ONLY\"],\"constants\":{\"ALERT_ONLY\":\"(2)\",\"TIME_OUT_WF\":\"(1)\",\"RETRY\":\"(0)\"},\"sampleValue\":\"RETRY\"},\"inputKeys\":[\"sample_inputKeys\"],\"concurrentExecLimit\":123,\"isolationGroupId\":\"sample_isolationGroupId\",\"retryCount\":123,\"description\":\"sample_description\",\"inputTemplate\":{\"sample_key\":\"sample_value\"},\"ownerEmail\":\"sample_ownerEmail\",\"baseType\":\"sample_baseType\",\"totalTimeoutSeconds\":123,\"retryDelaySeconds\":123,\"backoffScaleFactor\":123,\"rateLimitPerFrequency\":123,\"retryLogic\":{\"values\":[\"FIXED\",\"EXPONENTIAL_BACKOFF\",\"LINEAR_BACKOFF\"],\"constants\":{\"EXPONENTIAL_BACKOFF\":\"(1)\",\"FIXED\":\"(0)\",\"LINEAR_BACKOFF\":\"(2)\"},\"sampleValue\":\"FIXED\"},\"responseTimeoutSeconds\":123,\"name\":\"sample_name\",\"timeoutSeconds\":123,\"rateLimitFrequencyInSeconds\":123,\"outputKeys\":[\"sample_outputKeys\"],\"executionNameSpace\":\"sample_executionNameSpace\",\"pollTimeoutSeconds\":123},\"caseValueParam\":\"sample_caseValueParam\",\"dynamicForkTasksInputParamName\":\"sample_dynamicForkTasksInputParamName\",\"expression\":\"sample_expression\",\"loopCondition\":\"sample_loopCondition\",\"asyncComplete\":true,\"sink\":\"sample_sink\",\"rateLimited\":true,\"retryCount\":123,\"subWorkflowParam\":{\"workflowDefinition\":\"sample_workflowDefinition\",\"idempotencyKey\":\"sample_idempotencyKey\",\"name\":\"sample_name\",\"taskToDomain\":{\"sample_key\":\"sample_value\"},\"priority\":\"sample_object_priority\",\"version\":123,\"idempotencyStrategy\":{\"values\":[\"FAIL\",\"RETURN_EXISTING\",\"FAIL_ON_RUNNING\"],\"constants\":{\"FAIL_ON_RUNNING\":\"(2)\",\"RETURN_EXISTING\":\"(1)\",\"FAIL\":\"(0)\"},\"sampleValue\":\"FAIL\"}},\"optional\":true,\"joinStatus\":\"sample_joinStatus\",\"evaluatorType\":\"sample_evaluatorType\",\"dynamicTaskNameParam\":\"sample_dynamicTaskNameParam\",\"name\":\"sample_name\",\"startDelay\":123,\"permissive\":true,\"taskReferenceName\":\"sample_taskReferenceName\",\"defaultCase\":[],\"forkTasks\":[[]],\"dynamicForkTasksParam\":\"sample_dynamicForkTasksParam\"}]}],\"externalInputPayloadStoragePath\":\"sample_externalInputPayloadStoragePath\",\"lastRetriedTime\":123,\"parentWorkflowTaskId\":\"sample_parentWorkflowTaskId\",\"taskToDomain\":{\"sample_key\":\"sample_value\"},\"history\":[],\"priority\":123,\"failedReferenceTaskNames\":[\"sample_value\"],\"output\":{\"sample_key\":\"sample_value\"},\"input\":{\"sample_key\":\"sample_value\"},\"parentWorkflowId\":\"sample_parentWorkflowId\",\"failedTaskNames\":[\"sample_value\"],\"reasonForIncompletion\":\"sample_reasonForIncompletion\",\"reRunFromWorkflowId\":\"sample_reRunFromWorkflowId\",\"correlationId\":\"sample_correlationId\",\"endTime\":123,\"event\":\"sample_event\",\"workflowId\":\"sample_workflowId\",\"tasks\":[{\"retried\":true,\"outputData\":{\"sample_key\":\"sample_value\"},\"referenceTaskName\":\"sample_referenceTaskName\",\"workflowPriority\":123,\"isolationGroupId\":\"sample_isolationGroupId\",\"parentTaskId\":\"sample_parentTaskId\",\"executed\":true,\"subworkflowChanged\":true,\"taskType\":\"sample_taskType\",\"reasonForIncompletion\":\"sample_reasonForIncompletion\",\"responseTimeoutSeconds\":123,\"rateLimitFrequencyInSeconds\":123,\"iteration\":123,\"correlationId\":\"sample_correlationId\",\"startTime\":123,\"callbackFromWorker\":true,\"workflowType\":\"sample_workflowType\",\"workflowInstanceId\":\"sample_workflowInstanceId\",\"seq\":123,\"startDelayInSeconds\":123,\"inputData\":{\"sample_key\":\"sample_value\"},\"callbackAfterSeconds\":123,\"workerId\":\"sample_workerId\",\"scheduledTime\":123,\"externalInputPayloadStoragePath\":\"sample_externalInputPayloadStoragePath\",\"retryCount\":123,\"workflowTask\":{\"joinOn\":[\"sample_joinOn\"],\"description\":\"sample_description\",\"scriptExpression\":\"sample_scriptExpression\",\"cacheConfig\":{\"key\":\"sample_key\",\"ttlInSecond\":123},\"type\":\"sample_type\",\"inputParameters\":{\"sample_key\":\"sample_value\"},\"decisionCases\":{\"sample_key\":[{\"joinOn\":[\"sample_joinOn\"],\"description\":\"sample_description\",\"scriptExpression\":\"sample_scriptExpression\",\"cacheConfig\":{\"key\":\"sample_key\",\"ttlInSecond\":123},\"type\":\"sample_type\",\"inputParameters\":{\"sample_key\":\"sample_value\"},\"decisionCases\":{},\"loopOver\":[],\"caseExpression\":\"sample_caseExpression\",\"defaultExclusiveJoinTask\":[\"sample_defaultExclusiveJoinTask\"],\"taskDefinition\":{\"timeoutPolicy\":{\"values\":[\"RETRY\",\"TIME_OUT_WF\",\"ALERT_ONLY\"],\"constants\":{\"ALERT_ONLY\":\"(2)\",\"TIME_OUT_WF\":\"(1)\",\"RETRY\":\"(0)\"},\"sampleValue\":\"RETRY\"},\"inputKeys\":[\"sample_inputKeys\"],\"concurrentExecLimit\":123,\"isolationGroupId\":\"sample_isolationGroupId\",\"retryCount\":123,\"description\":\"sample_description\",\"inputTemplate\":{\"sample_key\":\"sample_value\"},\"ownerEmail\":\"sample_ownerEmail\",\"baseType\":\"sample_baseType\",\"totalTimeoutSeconds\":123,\"retryDelaySeconds\":123,\"backoffScaleFactor\":123,\"rateLimitPerFrequency\":123,\"retryLogic\":{\"values\":[\"FIXED\",\"EXPONENTIAL_BACKOFF\",\"LINEAR_BACKOFF\"],\"constants\":{\"EXPONENTIAL_BACKOFF\":\"(1)\",\"FIXED\":\"(0)\",\"LINEAR_BACKOFF\":\"(2)\"},\"sampleValue\":\"FIXED\"},\"responseTimeoutSeconds\":123,\"name\":\"sample_name\",\"timeoutSeconds\":123,\"rateLimitFrequencyInSeconds\":123,\"outputKeys\":[\"sample_outputKeys\"],\"executionNameSpace\":\"sample_executionNameSpace\",\"pollTimeoutSeconds\":123},\"caseValueParam\":\"sample_caseValueParam\",\"dynamicForkTasksInputParamName\":\"sample_dynamicForkTasksInputParamName\",\"expression\":\"sample_expression\",\"loopCondition\":\"sample_loopCondition\",\"asyncComplete\":true,\"sink\":\"sample_sink\",\"rateLimited\":true,\"retryCount\":123,\"subWorkflowParam\":{\"workflowDefinition\":\"sample_workflowDefinition\",\"idempotencyKey\":\"sample_idempotencyKey\",\"name\":\"sample_name\",\"taskToDomain\":{\"sample_key\":\"sample_value\"},\"priority\":\"sample_object_priority\",\"version\":123,\"idempotencyStrategy\":{\"values\":[\"FAIL\",\"RETURN_EXISTING\",\"FAIL_ON_RUNNING\"],\"constants\":{\"FAIL_ON_RUNNING\":\"(2)\",\"RETURN_EXISTING\":\"(1)\",\"FAIL\":\"(0)\"},\"sampleValue\":\"FAIL\"}},\"optional\":true,\"joinStatus\":\"sample_joinStatus\",\"evaluatorType\":\"sample_evaluatorType\",\"dynamicTaskNameParam\":\"sample_dynamicTaskNameParam\",\"name\":\"sample_name\",\"startDelay\":123,\"permissive\":true,\"taskReferenceName\":\"sample_taskReferenceName\",\"defaultCase\":[],\"forkTasks\":[[]],\"dynamicForkTasksParam\":\"sample_dynamicForkTasksParam\"}}],\"loopOver\":[],\"caseExpression\":\"sample_caseExpression\",\"defaultExclusiveJoinTask\":[\"sample_defaultExclusiveJoinTask\"],\"taskDefinition\":{\"timeoutPolicy\":{\"values\":[\"RETRY\",\"TIME_OUT_WF\",\"ALERT_ONLY\"],\"constants\":{\"ALERT_ONLY\":\"(2)\",\"TIME_OUT_WF\":\"(1)\",\"RETRY\":\"(0)\"},\"sampleValue\":\"RETRY\"},\"inputKeys\":[\"sample_inputKeys\"],\"concurrentExecLimit\":123,\"isolationGroupId\":\"sample_isolationGroupId\",\"retryCount\":123,\"description\":\"sample_description\",\"inputTemplate\":{\"sample_key\":\"sample_value\"},\"ownerEmail\":\"sample_ownerEmail\",\"baseType\":\"sample_baseType\",\"totalTimeoutSeconds\":123,\"retryDelaySeconds\":123,\"backoffScaleFactor\":123,\"rateLimitPerFrequency\":123,\"retryLogic\":{\"values\":[\"FIXED\",\"EXPONENTIAL_BACKOFF\",\"LINEAR_BACKOFF\"],\"constants\":{\"EXPONENTIAL_BACKOFF\":\"(1)\",\"FIXED\":\"(0)\",\"LINEAR_BACKOFF\":\"(2)\"},\"sampleValue\":\"FIXED\"},\"responseTimeoutSeconds\":123,\"name\":\"sample_name\",\"timeoutSeconds\":123,\"rateLimitFrequencyInSeconds\":123,\"outputKeys\":[\"sample_outputKeys\"],\"executionNameSpace\":\"sample_executionNameSpace\",\"pollTimeoutSeconds\":123},\"caseValueParam\":\"sample_caseValueParam\",\"dynamicForkTasksInputParamName\":\"sample_dynamicForkTasksInputParamName\",\"expression\":\"sample_expression\",\"loopCondition\":\"sample_loopCondition\",\"asyncComplete\":true,\"sink\":\"sample_sink\",\"rateLimited\":true,\"retryCount\":123,\"subWorkflowParam\":{\"workflowDefinition\":\"sample_workflowDefinition\",\"idempotencyKey\":\"sample_idempotencyKey\",\"name\":\"sample_name\",\"taskToDomain\":{\"sample_key\":\"sample_value\"},\"priority\":\"sample_object_priority\",\"version\":123,\"idempotencyStrategy\":{\"values\":[\"FAIL\",\"RETURN_EXISTING\",\"FAIL_ON_RUNNING\"],\"constants\":{\"FAIL_ON_RUNNING\":\"(2)\",\"RETURN_EXISTING\":\"(1)\",\"FAIL\":\"(0)\"},\"sampleValue\":\"FAIL\"}},\"optional\":true,\"joinStatus\":\"sample_joinStatus\",\"evaluatorType\":\"sample_evaluatorType\",\"dynamicTaskNameParam\":\"sample_dynamicTaskNameParam\",\"name\":\"sample_name\",\"startDelay\":123,\"permissive\":true,\"taskReferenceName\":\"sample_taskReferenceName\",\"defaultCase\":[],\"forkTasks\":[[]],\"dynamicForkTasksParam\":\"sample_dynamicForkTasksParam\"}],\"status\":{\"values\":[\"RUNNING\",\"COMPLETED\",\"FAILED\",\"TIMED_OUT\",\"TERMINATED\",\"PAUSED\"],\"constants\":{\"PAUSED\":\"(false, true)\",\"COMPLETED\":\"(true, true)\",\"FAILED\":\"(true, false)\",\"RUNNING\":\"(false, false)\",\"TIMED_OUT\":\"(true, false)\",\"TERMINATED\":\"(true, false)\"},\"sampleValue\":\"RUNNING\"},\"externalOutputPayloadStoragePath\":\"sample_externalOutputPayloadStoragePath\"}";

    @Test
    public void testSerializationDeserialization() throws Exception {
        ObjectMapper mapper = new ObjectMapper();
        Workflow workflow = mapper.readValue(serverJson, Workflow.class);
        assertNotNull(workflow);
        assertEquals(Workflow.WorkflowStatus.RUNNING, workflow.getStatus());
        assertEquals("sample_workflowId", workflow.getWorkflowId());
        assertEquals("sample_parentWorkflowId", workflow.getParentWorkflowId());
        assertEquals("sample_parentWorkflowTaskId", workflow.getParentWorkflowTaskId());
        assertNotNull(workflow.getTasks());
        assertFalse(workflow.getTasks().isEmpty());
        assertTrue(workflow.getInput().containsKey("sample_key"));
        assertEquals("sample_value", workflow.getInput().get("sample_key"));
        assertTrue(workflow.getOutput().containsKey("sample_key"));
        assertEquals("sample_value", workflow.getOutput().get("sample_key"));
        assertEquals("sample_correlationId", workflow.getCorrelationId());
        assertEquals("sample_reRunFromWorkflowId", workflow.getReRunFromWorkflowId());
        assertEquals("sample_reasonForIncompletion", workflow.getReasonForIncompletion());
        assertEquals("sample_event", workflow.getEvent());
        assertTrue(workflow.getTaskToDomain().containsKey("sample_key"));
        assertEquals("sample_value", workflow.getTaskToDomain().get("sample_key"));
        assertTrue(workflow.getFailedReferenceTaskNames().contains("sample_value"));
        assertNotNull(workflow.getWorkflowDefinition());
        assertEquals("sample_externalInputPayloadStoragePath", workflow.getExternalInputPayloadStoragePath());

        String serializedJson = mapper.writeValueAsString(workflow);
        assertEquals(mapper.readTree(serverJson), mapper.readTree(serializedJson));
    }
}