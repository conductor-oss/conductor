import com.fasterxml.jackson.databind.JsonNode
import com.fasterxml.jackson.databind.ObjectMapper
import org.junit.jupiter.api.Assertions
import org.junit.jupiter.api.Test

class TestSerDerWorkflowDef {
    private val objectMapper = ObjectMapper()
    private val serverJSON = """{"workflowStatusListenerSink":"sample_workflowStatusListenerSink","variables":{"sample_key":"sample_value"},"schemaVersion":123,"timeoutPolicy":{"values":["TIME_OUT_WF","ALERT_ONLY"],"constants":{"ALERT_ONLY":"(1)","TIME_OUT_WF":"(0)"},"sampleValue":"TIME_OUT_WF"},"outputSchema":{"data":{"sample_key":"sample_value"},"name":"sample_name","type":"SchemaDef.Type","version":123,"externalRef":"sample_externalRef"},"enforceSchema":true,"restartable":true,"inputSchema":{"data":{"sample_key":"sample_value"},"name":"sample_name","type":"SchemaDef.Type","version":123,"externalRef":"sample_externalRef"},"description":"sample_description","version":123,"inputParameters":["sample_inputParameters"],"inputTemplate":{"sample_key":"sample_value"},"workflowStatusListenerEnabled":true,"ownerEmail":"sample_ownerEmail","rateLimitConfig":{"concurrentExecLimit":123,"rateLimitKey":"sample_rateLimitKey"},"name":"sample_name","timeoutSeconds":123,"failureWorkflow":"sample_failureWorkflow","tasks":[{"joinOn":["sample_joinOn"],"description":"sample_description","scriptExpression":"sample_scriptExpression","cacheConfig":{"key":"sample_key","ttlInSecond":123},"type":"sample_type","inputParameters":{"sample_key":"sample_value"},"decisionCases":{"sample_key":[{"joinOn":["sample_joinOn"],"description":"sample_description","scriptExpression":"sample_scriptExpression","cacheConfig":{"key":"sample_key","ttlInSecond":123},"type":"sample_type","inputParameters":{"sample_key":"sample_value"},"decisionCases":{},"loopOver":[],"caseExpression":"sample_caseExpression","defaultExclusiveJoinTask":["sample_defaultExclusiveJoinTask"],"taskDefinition":{"timeoutPolicy":{"values":["RETRY","TIME_OUT_WF","ALERT_ONLY"],"constants":{"ALERT_ONLY":"(2)","TIME_OUT_WF":"(1)","RETRY":"(0)"},"sampleValue":"RETRY"},"inputKeys":["sample_inputKeys"],"concurrentExecLimit":123,"isolationGroupId":"sample_isolationGroupId","retryCount":123,"description":"sample_description","inputTemplate":{"sample_key":"sample_value"},"ownerEmail":"sample_ownerEmail","baseType":"sample_baseType","totalTimeoutSeconds":123,"retryDelaySeconds":123,"backoffScaleFactor":123,"rateLimitPerFrequency":123,"retryLogic":{"values":["FIXED","EXPONENTIAL_BACKOFF","LINEAR_BACKOFF"],"constants":{"EXPONENTIAL_BACKOFF":"(1)","FIXED":"(0)","LINEAR_BACKOFF":"(2)"},"sampleValue":"FIXED"},"responseTimeoutSeconds":123,"name":"sample_name","timeoutSeconds":123,"rateLimitFrequencyInSeconds":123,"outputKeys":["sample_outputKeys"],"executionNameSpace":"sample_executionNameSpace","pollTimeoutSeconds":123},"caseValueParam":"sample_caseValueParam","dynamicForkTasksInputParamName":"sample_dynamicForkTasksInputParamName","expression":"sample_expression","loopCondition":"sample_loopCondition","asyncComplete":true,"sink":"sample_sink","rateLimited":true,"retryCount":123,"subWorkflowParam":{"workflowDefinition":"sample_workflowDefinition","idempotencyKey":"sample_idempotencyKey","name":"sample_name","taskToDomain":{"sample_key":"sample_value"},"priority":"sample_object_priority","version":123,"idempotencyStrategy":{"values":["FAIL","RETURN_EXISTING","FAIL_ON_RUNNING"],"constants":{"FAIL_ON_RUNNING":"(2)","RETURN_EXISTING":"(1)","FAIL":"(0)"},"sampleValue":"FAIL"}},"optional":true,"joinStatus":"sample_joinStatus","evaluatorType":"sample_evaluatorType","dynamicTaskNameParam":"sample_dynamicTaskNameParam","name":"sample_name","startDelay":123,"permissive":true,"taskReferenceName":"sample_taskReferenceName","defaultCase":[],"forkTasks":[[]],"dynamicForkTasksParam":"sample_dynamicForkTasksParam"}]},"loopOver":[{"joinOn":["sample_joinOn"],"description":"sample_description","scriptExpression":"sample_scriptExpression","cacheConfig":{"key":"sample_key","ttlInSecond":123},"type":"sample_type","inputParameters":{"sample_key":"sample_value"},"decisionCases":{},"loopOver":[],"caseExpression":"sample_caseExpression","defaultExclusiveJoinTask":["sample_defaultExclusiveJoinTask"],"taskDefinition":{"timeoutPolicy":{"values":["RETRY","TIME_OUT_WF","ALERT_ONLY"],"constants":{"ALERT_ONLY":"(2)","TIME_OUT_WF":"(1)","RETRY":"(0)"},"sampleValue":"RETRY"},"inputKeys":["sample_inputKeys"],"concurrentExecLimit":123,"isolationGroupId":"sample_isolationGroupId","retryCount":123,"description":"sample_description","inputTemplate":{"sample_key":"sample_value"},"ownerEmail":"sample_ownerEmail","baseType":"sample_baseType","totalTimeoutSeconds":123,"retryDelaySeconds":123,"backoffScaleFactor":123,"rateLimitPerFrequency":123,"retryLogic":{"values":["FIXED","EXPONENTIAL_BACKOFF","LINEAR_BACKOFF"],"constants":{"EXPONENTIAL_BACKOFF":"(1)","FIXED":"(0)","LINEAR_BACKOFF":"(2)"},"sampleValue":"FIXED"},"responseTimeoutSeconds":123,"name":"sample_name","timeoutSeconds":123,"rateLimitFrequencyInSeconds":123,"outputKeys":["sample_outputKeys"],"executionNameSpace":"sample_executionNameSpace","pollTimeoutSeconds":123},"caseValueParam":"sample_caseValueParam","dynamicForkTasksInputParamName":"sample_dynamicForkTasksInputParamName","expression":"sample_expression","loopCondition":"sample_loopCondition","asyncComplete":true,"sink":"sample_sink","rateLimited":true,"retryCount":123,"subWorkflowParam":{"workflowDefinition":"sample_workflowDefinition","idempotencyKey":"sample_idempotencyKey","name":"sample_name","taskToDomain":{"sample_key":"sample_value"},"priority":"sample_object_priority","version":123,"idempotencyStrategy":{"values":["FAIL","RETURN_EXISTING","FAIL_ON_RUNNING"],"constants":{"FAIL_ON_RUNNING":"(2)","RETURN_EXISTING":"(1)","FAIL":"(0)"},"sampleValue":"FAIL"}},"optional":true,"joinStatus":"sample_joinStatus","evaluatorType":"sample_evaluatorType","dynamicTaskNameParam":"sample_dynamicTaskNameParam","name":"sample_name","startDelay":123,"permissive":true,"taskReferenceName":"sample_taskReferenceName","defaultCase":[],"forkTasks":[[]],"dynamicForkTasksParam":"sample_dynamicForkTasksParam"}],"caseExpression":"sample_caseExpression","defaultExclusiveJoinTask":["sample_defaultExclusiveJoinTask"],"taskDefinition":{"timeoutPolicy":{"values":["RETRY","TIME_OUT_WF","ALERT_ONLY"],"constants":{"ALERT_ONLY":"(2)","TIME_OUT_WF":"(1)","RETRY":"(0)"},"sampleValue":"RETRY"},"inputKeys":["sample_inputKeys"],"concurrentExecLimit":123,"isolationGroupId":"sample_isolationGroupId","retryCount":123,"description":"sample_description","inputTemplate":{"sample_key":"sample_value"},"ownerEmail":"sample_ownerEmail","baseType":"sample_baseType","totalTimeoutSeconds":123,"retryDelaySeconds":123,"backoffScaleFactor":123,"rateLimitPerFrequency":123,"retryLogic":{"values":["FIXED","EXPONENTIAL_BACKOFF","LINEAR_BACKOFF"],"constants":{"EXPONENTIAL_BACKOFF":"(1)","FIXED":"(0)","LINEAR_BACKOFF":"(2)"},"sampleValue":"FIXED"},"responseTimeoutSeconds":123,"name":"sample_name","timeoutSeconds":123,"rateLimitFrequencyInSeconds":123,"outputKeys":["sample_outputKeys"],"executionNameSpace":"sample_executionNameSpace","pollTimeoutSeconds":123},"caseValueParam":"sample_caseValueParam","dynamicForkTasksInputParamName":"sample_dynamicForkTasksInputParamName","expression":"sample_expression","loopCondition":"sample_loopCondition","asyncComplete":true,"sink":"sample_sink","rateLimited":true,"retryCount":123,"subWorkflowParam":{"workflowDefinition":"sample_workflowDefinition","idempotencyKey":"sample_idempotencyKey","name":"sample_name","taskToDomain":{"sample_key":"sample_value"},"priority":"sample_object_priority","version":123,"idempotencyStrategy":{"values":["FAIL","RETURN_EXISTING","FAIL_ON_RUNNING"],"constants":{"FAIL_ON_RUNNING":"(2)","RETURN_EXISTING":"(1)","FAIL":"(0)"},"sampleValue":"FAIL"}},"optional":true,"joinStatus":"sample_joinStatus","evaluatorType":"sample_evaluatorType","dynamicTaskNameParam":"sample_dynamicTaskNameParam","name":"sample_name","startDelay":123,"permissive":true,"taskReferenceName":"sample_taskReferenceName","defaultCase":[{"joinOn":["sample_joinOn"],"description":"sample_description","scriptExpression":"sample_scriptExpression","cacheConfig":{"key":"sample_key","ttlInSecond":123},"type":"sample_type","inputParameters":{"sample_key":"sample_value"},"decisionCases":{},"loopOver":[],"caseExpression":"sample_caseExpression","defaultExclusiveJoinTask":["sample_defaultExclusiveJoinTask"],"taskDefinition":{"timeoutPolicy":{"values":["RETRY","TIME_OUT_WF","ALERT_ONLY"],"constants":{"ALERT_ONLY":"(2)","TIME_OUT_WF":"(1)","RETRY":"(0)"},"sampleValue":"RETRY"},"inputKeys":["sample_inputKeys"],"concurrentExecLimit":123,"isolationGroupId":"sample_isolationGroupId","retryCount":123,"description":"sample_description","inputTemplate":{"sample_key":"sample_value"},"ownerEmail":"sample_ownerEmail","baseType":"sample_baseType","totalTimeoutSeconds":123,"retryDelaySeconds":123,"backoffScaleFactor":123,"rateLimitPerFrequency":123,"retryLogic":{"values":["FIXED","EXPONENTIAL_BACKOFF","LINEAR_BACKOFF"],"constants":{"EXPONENTIAL_BACKOFF":"(1)","FIXED":"(0)","LINEAR_BACKOFF":"(2)"},"sampleValue":"FIXED"},"responseTimeoutSeconds":123,"name":"sample_name","timeoutSeconds":123,"rateLimitFrequencyInSeconds":123,"outputKeys":["sample_outputKeys"],"executionNameSpace":"sample_executionNameSpace","pollTimeoutSeconds":123},"caseValueParam":"sample_caseValueParam","dynamicForkTasksInputParamName":"sample_dynamicForkTasksInputParamName","expression":"sample_expression","loopCondition":"sample_loopCondition","asyncComplete":true,"sink":"sample_sink","rateLimited":true,"retryCount":123,"subWorkflowParam":{"workflowDefinition":"sample_workflowDefinition","idempotencyKey":"sample_idempotencyKey","name":"sample_name","taskToDomain":{"sample_key":"sample_value"},"priority":"sample_object_priority","version":123,"idempotencyStrategy":{"values":["FAIL","RETURN_EXISTING","FAIL_ON_RUNNING"],"constants":{"FAIL_ON_RUNNING":"(2)","RETURN_EXISTING":"(1)","FAIL":"(0)"},"sampleValue":"FAIL"}},"optional":true,"joinStatus":"sample_joinStatus","evaluatorType":"sample_evaluatorType","dynamicTaskNameParam":"sample_dynamicTaskNameParam","name":"sample_name","startDelay":123,"permissive":true,"taskReferenceName":"sample_taskReferenceName","defaultCase":[],"forkTasks":[[]],"dynamicForkTasksParam":"sample_dynamicForkTasksParam"}],"forkTasks":[[{"joinOn":["sample_joinOn"],"description":"sample_description","scriptExpression":"sample_scriptExpression","cacheConfig":{"key":"sample_key","ttlInSecond":123},"type":"sample_type","inputParameters":{"sample_key":"sample_value"},"decisionCases":{},"loopOver":[],"caseExpression":"sample_caseExpression","defaultExclusiveJoinTask":["sample_defaultExclusiveJoinTask"],"taskDefinition":{"timeoutPolicy":{"values":["RETRY","TIME_OUT_WF","ALERT_ONLY"],"constants":{"ALERT_ONLY":"(2)","TIME_OUT_WF":"(1)","RETRY":"(0)"},"sampleValue":"RETRY"},"inputKeys":["sample_inputKeys"],"concurrentExecLimit":123,"isolationGroupId":"sample_isolationGroupId","retryCount":123,"description":"sample_description","inputTemplate":{"sample_key":"sample_value"},"ownerEmail":"sample_ownerEmail","baseType":"sample_baseType","totalTimeoutSeconds":123,"retryDelaySeconds":123,"backoffScaleFactor":123,"rateLimitPerFrequency":123,"retryLogic":{"values":["FIXED","EXPONENTIAL_BACKOFF","LINEAR_BACKOFF"],"constants":{"EXPONENTIAL_BACKOFF":"(1)","FIXED":"(0)","LINEAR_BACKOFF":"(2)"},"sampleValue":"FIXED"},"responseTimeoutSeconds":123,"name":"sample_name","timeoutSeconds":123,"rateLimitFrequencyInSeconds":123,"outputKeys":["sample_outputKeys"],"executionNameSpace":"sample_executionNameSpace","pollTimeoutSeconds":123},"caseValueParam":"sample_caseValueParam","dynamicForkTasksInputParamName":"sample_dynamicForkTasksInputParamName","expression":"sample_expression","loopCondition":"sample_loopCondition","asyncComplete":true,"sink":"sample_sink","rateLimited":true,"retryCount":123,"subWorkflowParam":{"workflowDefinition":"sample_workflowDefinition","idempotencyKey":"sample_idempotencyKey","name":"sample_name","taskToDomain":{"sample_key":"sample_value"},"priority":"sample_object_priority","version":123,"idempotencyStrategy":{"values":["FAIL","RETURN_EXISTING","FAIL_ON_RUNNING"],"constants":{"FAIL_ON_RUNNING":"(2)","RETURN_EXISTING":"(1)","FAIL":"(0)"},"sampleValue":"FAIL"}},"optional":true,"joinStatus":"sample_joinStatus","evaluatorType":"sample_evaluatorType","dynamicTaskNameParam":"sample_dynamicTaskNameParam","name":"sample_name","startDelay":123,"permissive":true,"taskReferenceName":"sample_taskReferenceName","defaultCase":[],"forkTasks":[[]],"dynamicForkTasksParam":"sample_dynamicForkTasksParam"}]],"dynamicForkTasksParam":"sample_dynamicForkTasksParam"}],"outputParameters":{"sample_key":"sample_value"}}"""

    @Test
    fun testWorkflowDefSerializationDeserialization() {
        val workflowDef = objectMapper.readValue(serverJSON, WorkflowDef::class.java)
        Assertions.assertEquals("sample_workflowStatusListenerSink", workflowDef.workflowStatusListenerSink)
        Assertions.assertEquals("sample_name", workflowDef.name)
        Assertions.assertEquals(123, workflowDef.version)
        Assertions.assertTrue(workflowDef.enforceSchema)
        Assertions.assertTrue(workflowDef.restartable)
        Assertions.assertTrue(workflowDef.workflowStatusListenerEnabled)
        Assertions.assertEquals("sample_ownerEmail", workflowDef.ownerEmail)
        Assertions.assertEquals(123, workflowDef.rateLimitConfig.concurrentExecLimit)
        Assertions.assertEquals("sample_rateLimitKey", workflowDef.rateLimitConfig.rateLimitKey)
        Assertions.assertEquals(WorkflowDef.TimeoutPolicy.TIME_OUT_WF, workflowDef.timeoutPolicy)
        Assertions.assertEquals(123, workflowDef.timeoutSeconds)
        Assertions.assertEquals("sample_failureWorkflow", workflowDef.failureWorkflow)
        Assertions.assertNotNull(workflowDef.tasks)
        Assertions.assertFalse(workflowDef.tasks.isEmpty())
        val serializedJSON = objectMapper.writeValueAsString(workflowDef)
        val originalJsonNode: JsonNode = objectMapper.readTree(serverJSON)
        val serializedJsonNode: JsonNode = objectMapper.readTree(serializedJSON)
        Assertions.assertEquals(originalJsonNode, serializedJsonNode)
    }
}